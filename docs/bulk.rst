Bulk upload of metadata to the TaRGET II DCC
================

Description
-----------

The following instructions can be used to upload metadata to the TaRGET II DCC metadata database from an Excel template. You can use them to: 1. Upload new metadata to the database; 2. Update existing records in the database; 3. Establish relationships between metadata records.

How to use it
-------------

1. Install the upload script.

    a. Python3 is required to run the bulk upload script. Please install python3 or use python3 from Anaconda (https://www.continuum.io/downloads). When you have python3 installed, run the following command to install the upload script and its dependencies:
    
    ::
        
        pip install --user submitTaRGET
    
    or
    
    ::

        pip3 install --user submitTaRGET

2. Obtain your API key.

    a. Log in to the Submission UI (submit.target.wustl.edu). On your first login, you will need to register as a new user (“Create New Account”). After completing all fields, select “Create”, then “Login”.
    b. On the homepage, click “Show API key” to get your token.

    .. image:: _static/tb01.png

3. Download and fill in the Excel template (TaRGET_metadata_V<2.0>.xlsx). 

    a. A blank copy of the most recent template can be downloaded from the TaRGET Submission UI homepage or Bulk Upload page ("Download Bulk Upload Excel template"). You must use our template for bulk upload. 

    .. image:: _static/TemplateDownload1.png
    
    .. image:: _static/TemplateDownload2.png

    b. If you rename the template, be sure to keep the version number intact in the name. 
    c. All required fields must be populated. 
    d. Link metadata entries together by entering User or System Accessions in the blue relationship columns (see below). 
    e. Enter dates as Excel-formatted dates or a string with format "YYYY-MM-DD".
    f. Group together technical replicates from a single mouse within an Experiment.

4. To upload new metadata: 
    
    a. Leave the System Accession column blank. If a System Accession is found, the data in that row will not be uploaded. 
    b. Metadata can be linked to other records already in the metadata database with their System Accession. To establish relationships between records you are uploading at the same time, a User Accession can be used as a temporary placeholder. Please fill in the User Accession according to the format for that tab. All User Accessions must be unique within an Excel file. If a record will not be linked to any other record, it is not necessary to include a User Accession.

    c. To validate the sheet, run the following command on the command line. Contact the DCC if there are errors you cannot resolve.

    ::

        submitTaRGET -k <API key> -x <path to excel file>
   
    d. Once all errors have been addressed, run the following command to upload the metadata to the database.  

    ::

        submitTaRGET -k <API key> -x <path to excel file> --notest   
           
5. To upload new metadata and save User Accessions:

    a. By default, the User Accessions you enter will be removed once your records are uploaded and assigned System Accessions. However, if you would like to retain the User Accessions in the database for record-keeping purposes, you can choose to save them at submission using the ``--saveacc`` flag. 
    b. If the ``--saveacc`` flag is used, all records must have User Accessions, and User Accessions must be unique across all records submitted by the same user. 

    c. If you are using the ``--saveacc`` flag, validate your metadata with:
   
    ::

        submitTaRGET -k <API key> -x <excel file> --saveacc
   
    d. And submit with: 
   
    ::

        submitTaRGET -k <API key> -x <excel file> --saveacc --notest

6. To update existing records in the metadata database:
   
    a. On the Submission Dashboard, click the "Download" button next to the submission. This will download the most recent metadata template populated with your submitted metadata, as well as the automatically generated System Accessions for each entry. Only metadata submitted via bulk upload are available for batch download.

    .. image:: _static/SubmissionDownload.png

    b. Any changes made to an object between batch submission and re-download will be included.  
    c. To update metadata, the System Accession generated by the database must be present. The User Accession column will be ignored. When updating metadata, only System Accessions may be used to establish relationships.
    d. Entries cannot be delted by removing the row on the Excel sheet; they must be deleted through the UI.

    e. After editing the Excel, validate the modified sheet using the following command. Contact the DCC if there are errors you cannot resolve.

    ::
   
        submitTaRGET -k <API key> -x <excel file> --update

    f. Once all errors have been addressed, run the following command to update the metadata.  

    ::

        submitTaRGET -k <API key> -x <excel file> --update --notest

   .. rubric:: A summary flow chart
      :name: a-summary-flow-chart

   .. figure:: https://github.com/xzhuo/TargetBulkUpload/blob/master/bulkupload_flow.20170714.png
      :alt: submit summary flow chart

      Flow chart

See the github repo TargetBulkUpload for more scripts and more information. 

Video tutorial to get started.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

    .. youtube:: https://www.youtube.com/watch?v=qDBxSGySTsI
    .. raw:: html

        <div style="position: relative; height: 0; overflow: hidden; max-width: 100%; height: auto;">
            <iframe width="640" height="400" src="https://www.youtube.com/embed/qDBxSGySTsI" frameborder="0" allowfullscreen></iframe>
        </div>
    
    .. youtube:: https://www.youtube.com/watch?v=233F6YpFfOQ
    .. raw:: html

        <div style="position: relative; height: 0; overflow: hidden; max-width: 100%; height: auto;">
            <iframe width="640" height="400" src="https://www.youtube.com/embed/233F6YpFfOQ" frameborder="0" allowfullscreen></iframe>
        </div>
